<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Physical Inventory Entry</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root { --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#475569; --primary:#0ea5e9; --border:#e2e8f0; --danger:#ef4444; --success:#22c55e; }
    html,body{height:100%} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,'Helvetica Neue',Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1000px;margin:0 auto;padding:16px}.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}.row-3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px}@media(max-width:820px){.row,.row-3{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block} input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
    input[type=number]{appearance:textfield} input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    .btns{display:flex;gap:10px;flex-wrap:wrap} button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-weight:600}
    .primary{background:var(--primary);color:#fff;border-color:var(--primary)} .danger{background:var(--danger);color:#fff;border-color:var(--danger)} .success{background:var(--success);color:#fff;border-color:var(--success)}
    .muted{color:var(--muted)} table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px} th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f1f5f9;font-weight:700;font-size:12px;color:#334155}.pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .tag{background:#eef2ff;border-color:#c7d2fe;color:#4338ca}.right{text-align:right}.toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:8px}
    .grow{flex:1}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Courier New',monospace}.chip{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#334155;display:inline-flex;align-items:center;gap:6px}
    .footer{color:var(--muted);font-size:12px;margin-top:18px} .searchbar{display:flex; gap:10px; align-items:center; margin-top:8px;}
  </style>
</head>
<body>
  <div class="container">
    <h2>Physical Inventory Entry</h2>

    <div class="card">
      <div class="toolbar">
        <div>
          <span class="chip">Parts loaded: <strong id="partsCount">0</strong></span>
          <span class="chip">Endpoint: <strong id="epStatus">Not set</strong></span>
        </div>
        <div class="searchbar">
          <input id="findInput" placeholder="Search parts list (code or description)…" />
          <button id="showParts">Open Parts List</button>
        </div>
      </div>
      <div id="partsPanel" style="display:none; margin-top:10px;">
        <table id="partsTable">
          <thead><tr><th>Part Code</th><th>Description</th><th>UOM</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer">Two-way sync enabled: add/update/delete. App queues offline and auto-resyncs.</div>
    </div>

    <div style="height:12px"></div>

    <div class="card" id="settings">
      <div class="row">
        <div><label>Auditor Name</label><input id="auditor" placeholder="Enter your name" /></div>
        <div><label>Location</label><select id="plant"><option value="">Select</option><option value="Dehu">Dehu</option><option value="Chakan">Chakan</option></select></div>
      </div>
      <div class="footer">Fill once. Values auto-attach to each entry.</div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <form id="entryForm">
        <div class="row-3">
          <div>
            <label>Part Code <span class="pill tag">required</span></label>
            <input id="part" list="partsList" placeholder="Start typing to search…" autocomplete="off" required />
            <datalist id="partsList"></datalist>
          </div>
          <div><label>Quantity <span class="pill tag">required</span></label><input id="qty" type="number" inputmode="numeric" step="1" min="0" placeholder="0" required /></div>
          <div><label>Zone (optional)</label><input id="zone" placeholder="e.g., A-12" /></div>
        </div>
        <div style="height:10px"></div>
        <div class="btns">
          <button class="primary" id="submitBtn" type="submit">Save Entry (Enter)</button>
          <button type="button" id="updateBtn" class="success" style="display:none;">Update Entry</button>
          <button type="button" id="clearBtn">Clear Fields (Esc)</button>
          <span class="grow"></span>
          <button type="button" id="undoBtn">Undo Last</button>
          <button type="button" id="clearAllBtn" class="danger">Clear All (device)</button>
        </div>
      </form>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="toolbar">
        <div>
          <span class="chip">Total Entries: <strong id="count">0</strong></span>
          <span class="chip">Pending Sync: <strong id="pending">0</strong></span>
        </div>
        <div class="muted">Tap a row to edit. Use Delete on the right to remove (mirrored to Sheets).</div>
      </div>
      <table id="table">
        <thead><tr><th>#</th><th>Timestamp</th><th>Auditor</th><th>Location</th><th>Part Code</th><th class="right">Qty</th><th>Zone</th><th>Status</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer">Exports available (All/Dehu/Chakan) as fallback snapshots.</div>

    <div style="height:12px"></div>
    <div class="card">
      <div class="btns">
        <button type="button" id="exportAll" class="primary">Export All (CSV)</button>
        <button type="button" id="exportDehu">Export Dehu (CSV)</button>
        <button type="button" id="exportChakan">Export Chakan (CSV)</button>
        <span class="grow"></span>
        <button type="button" id="resyncBtn">Resync Pending</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(console.error));
    }
  </script>

  <script>
    const $ = id => document.getElementById(id);
    const LS_KEY = 'inv_entries_sheets_v3del';
    const SETTINGS_KEY = 'inv_settings_sheets_v3del';
    const QUEUE_KEY = 'inv_queue_sheets_v3del';

    let editingId = null;

    function nowISO(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
    const load = (k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)||d); }catch{ return JSON.parse(d);} };
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

    function loadEntries(){ return load(LS_KEY,'[]'); }
    function saveEntries(v){ save(LS_KEY,v); }
    function loadSettings(){ return load(SETTINGS_KEY,'{}'); }
    function saveSettings(v){ save(SETTINGS_KEY, v); }
    function loadQueue(){ return load(QUEUE_KEY,'[]'); }
    function saveQueue(v){ save(QUEUE_KEY, v); }

    function endpointStatus(){
      const cfg = window.APP_CONFIG || {}; 
      const ep = (cfg.SHEETS_ENDPOINT||'').trim();
      const el = $('epStatus'); if (!el) return;
      el.textContent = ep ? (ep.endsWith('/exec') ? 'OK' : 'URL not /exec') : 'Not set';
    }

    async function callSheets(payload){
      const cfg = window.APP_CONFIG || {}; 
      const ep = (cfg.SHEETS_ENDPOINT||'').trim();
      endpointStatus();
      if (!ep || cfg.BACKEND !== 'SHEETS') return false;
      try{
        const res = await fetch(ep, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
        return res.ok;
      }catch(e){ console.warn('Sheets call failed', e); return false; }
    }

    function renderPartsUI(){
      const parts = window.EMBEDDED_PARTS || [];
      const pc = $('partsCount'); if (pc) pc.textContent = parts.length || 0;
      const list = $('partsList'); if (list){
        list.innerHTML = '';
        const seen = new Set();
        parts.forEach(p => {
          if (!p || !p.code || seen.has(p.code)) return;
          seen.add(p.code);
          const opt = document.createElement('option'); opt.value = p.code; opt.label = p.name ? `${p.code} — ${p.name}` : p.code;
          list.appendChild(opt);
        });
      }
      const tbody = document.querySelector('#partsTable tbody');
      if (tbody){
        tbody.innerHTML = '';
        (window.EMBEDDED_PARTS || []).slice(0, 2000).forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="mono">${p.code}</td><td>${p.name||''}</td><td>${p.uom||''}</td><td><button data-pick="${p.code}">Pick</button></td>`;
          tbody.appendChild(tr);
        });
      }
    }

    function renderEntries(){
      const tbody = document.querySelector('#table tbody'); tbody.innerHTML='';
      const entries = loadEntries();
      const queueIds = new Set(loadQueue().map(q=>q.id));
      entries.forEach((e,i)=>{
        const tr=document.createElement('tr'); tr.dataset.id=e.id;
        const status = queueIds.has(e.id) ? 'Pending' : (e.synced?'Synced':'Local');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td class="mono">${e.ts}</td>
          <td>${e.auditor||''}</td>
          <td>${e.plant||''}</td>
          <td class="mono">${e.part}</td>
          <td class="right">${e.qty}</td>
          <td>${e.zone||''}</td>
          <td>${status}</td>
          <td class="right"><button data-del="${e.id}">Delete</button></td>`;
        tr.addEventListener('click', (ev)=>{
          if (ev.target && ev.target.dataset.del) return;
          editingId=e.id; $('part').value=e.part; $('qty').value=e.qty; $('zone').value=e.zone||'';
          $('submitBtn').style.display='none'; $('updateBtn').style.display=''; $('part').focus();
        });
        tbody.appendChild(tr);
      });
      $('count').textContent = entries.length;
      $('pending').textContent = loadQueue().length;
    }

    async function enqueueAndSync(payload){
      const q = loadQueue(); q.push({ id: payload.id, op: payload.op }); saveQueue(q); renderEntries();
      const ok = await callSheets(payload);
      if (ok){
        const entries = loadEntries();
        const i = entries.findIndex(x=>x.id===payload.id);
        if (payload.op === 'delete'){
          // Local already removed; just clear queue item
          saveQueue(loadQueue().filter(x=>x.id!==payload.id));
          renderEntries();
          return;
        }
        if (i>=0){ entries[i].synced = true; saveEntries(entries); }
        saveQueue(loadQueue().filter(x=>x.id!==payload.id));
        renderEntries();
      }
    }

    function addEntry(part, qty, zone){
      const s = loadSettings();
      const entry = { id: crypto.randomUUID(), ts: nowISO(), plant: s.plant||'', auditor: s.auditor||'', part, qty: Number(qty), zone: zone||'', synced:false };
      const entries = loadEntries(); entries.push(entry); saveEntries(entries); renderEntries();
      enqueueAndSync({ op:'upsert', ...entry });
    }
    function updateEntry(id, part, qty, zone){
      const entries=loadEntries(); const i=entries.findIndex(x=>x.id===id);
      if(i>=0){ const s=loadSettings();
        entries[i]={...entries[i], ts:nowISO(), part, qty:Number(qty), zone:zone||'', auditor:s.auditor||entries[i].auditor, plant:s.plant||entries[i].plant, synced:false};
        saveEntries(entries); renderEntries();
        enqueueAndSync({ op:'upsert', ...entries[i] });
      }
    }
    function deleteEntry(id){
      const entries=loadEntries(); const rec = entries.find(x=>x.id===id);
      saveEntries(entries.filter(x=>x.id!==id)); renderEntries();
      if (rec){ enqueueAndSync({ op:'delete', id: rec.id, plant: rec.plant }); }
    }

    function downloadCSVNamed(csv, suffix){
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href=url; a.download=`inventory_entries_${suffix}_${stamp}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
    function csvFromEntries(filterPlant){
      const rows = loadEntries().filter(e=>!filterPlant || e.plant===filterPlant).map(e=>[e.ts,e.plant||'',e.auditor||'',e.part,e.qty,e.zone||'']);
      const header = ['Timestamp','Plant','Auditor','PartCode','Quantity','Zone'];
      return [header.join(','), ...rows.map(r => r.map(v => String(v).includes(',') ? '"' + String(v).replaceAll('"','""') + '"' : v).join(','))].join('\n');
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      const s=loadSettings(); if(s.auditor) $('auditor').value=s.auditor; if(s.plant) $('plant').value=s.plant;
      $('auditor').addEventListener('change', ()=> saveSettings({...loadSettings(), auditor:$('auditor').value.trim()}));
      $('plant').addEventListener('change', ()=> saveSettings({...loadSettings(), plant:$('plant').value}));

      renderPartsUI();
      renderEntries();

      $('entryForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const part=$('part').value.trim(); const qty=$('qty').value; const zone=$('zone').value.trim();
        if(!part){ $('part').focus(); return; }
        if(qty==='' || isNaN(qty) || Number(qty) < 0){ $('qty').focus(); return; }
        if(editingId){ updateEntry(editingId, part, qty, zone); } else { addEntry(part, qty, zone); }
        $('entryForm').reset(); editingId=null; $('submitBtn').style.display=''; $('updateBtn').style.display='none'; $('part').focus();
      });
      $('clearBtn').addEventListener('click', ()=>{ $('entryForm').reset(); editingId=null; $('submitBtn').style.display=''; $('updateBtn').style.display='none'; $('part').focus(); });
      $('undoBtn').addEventListener('click', ()=>{ const e=loadEntries(); e.pop(); saveEntries(e); renderEntries(); });
      $('clearAllBtn').addEventListener('click', ()=>{ if(confirm('Clear ALL entries on this device?')){ saveEntries([]); saveQueue([]); renderEntries(); } });
      document.querySelector('#table').addEventListener('click', (e)=>{ const id=e.target?.dataset?.del; if(!id) return; deleteEntry(id); });

      $('exportAll').addEventListener('click', ()=> downloadCSVNamed(csvFromEntries(null), 'ALL'));
      $('exportDehu').addEventListener('click', ()=> downloadCSVNamed(csvFromEntries('Dehu'), 'DEHU'));
      $('exportChakan').addEventListener('click', ()=> downloadCSVNamed(csvFromEntries('Chakan'), 'CHAKAN'));

      $('resyncBtn').addEventListener('click', async ()=>{
        const q = loadQueue();
        const entries = loadEntries();
        for (const item of [...q]){
          const payload = item.op === 'delete' ? { op:'delete', id:item.id } : { op:'upsert', ...entries.find(e=>e.id===item.id) };
          const ok = await callSheets(payload);
          if (ok){
            if (item.op !== 'delete'){ const i = entries.findIndex(e=>e.id===item.id); if (i>=0){ entries[i].synced = true; saveEntries(entries); } }
            saveQueue(loadQueue().filter(x=>x.id!==item.id));
          }
        }
        renderEntries();
      });

      $('showParts').addEventListener('click', ()=>{
        const panel = $('partsPanel');
        panel.style.display = panel.style.display === 'none' ? '' : 'none';
      });
      $('findInput').addEventListener('input', (e)=>{
        const q = e.target.value.toLowerCase();
        const tbody = document.querySelector('#partsTable tbody');
        const parts = window.EMBEDDED_PARTS || [];
        tbody.innerHTML = '';
        parts.forEach(p => {
          const hay = (String(p.code||'') + ' ' + String(p.name||'')).toLowerCase();
          if (q && hay.indexOf(q) === -1) return;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="mono">${p.code}</td><td>${p.name||''}</td><td>${p.uom||''}</td><td><button data-pick="${p.code}">Pick</button></td>`;
          tbody.appendChild(tr);
        });
      });
      document.querySelector('#partsTable').addEventListener('click', (e)=>{
        const code = e.target?.dataset?.pick; if (!code) return;
        $('part').value = code; window.scrollTo({top:0, behavior:'smooth'}); $('qty').focus();
      });

      window.addEventListener('online', ()=> $('resyncBtn').click());
      endpointStatus();
    });
  </script>
</body>
</html>